services:
    data:
        container_name: sqlserver
        image: mcr.microsoft.com/mssql/server:2019-latest
        ports:
            - "1433:1433"
        environment:
            - ACCEPT_EULA=Y
            - SA_PASSWORD=YOUR_SQL_PASSWORD_HERE
        restart: unless-stopped
        volumes:
            - sqldata:/var/opt/mssql
        networks:
            - body4uhub-network
        healthcheck:
            test: /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P "YOUR_SQL_PASSWORD_HERE" -Q "SELECT 1" || exit 1
            interval: 30s
            timeout: 10s
            retries: 5
            start_period: 60s
        deploy:
            resources:
                limits:
                    cpus: '2.0'
                    memory: 4G
                reservations:
                    cpus: '1.0'
                    memory: 2G
            
    message:
        container_name: rabbitmq
        image: rabbitmq:management-alpine
        ports:
            - "5672:5672"
        hostname: "rabbitmq"
        environment:
            - RABBITMQ_DEFAULT_USER=YourUsername
            - RABBITMQ_DEFAULT_PASS=YourPassword
        restart: unless-stopped
        volumes:
            - rabbitmq-lib:/var/lib/rabbitmq/
        networks:
            - body4uhub-network
        healthcheck:
            test: rabbitmq-diagnostics -q ping
            interval: 30s
            timeout: 10s
            retries: 5
            start_period: 30s
        deploy:
            resources:
                limits:
                    cpus: '1.0'
                    memory: 1G
                reservations:
                    cpus: '0.5'
                    memory: 512M
            
    identity:
        container_name: identity
        image: dkisov/body4u-hub-identity-service
        build:
            context: ./
            dockerfile: ./Body4uHUB.Identity.Api/Dockerfile
        ports:
            - "5001:8080"
        env_file: 
            - ./Body4uHUB.Identity.Api/identity.env
        restart: unless-stopped
        volumes:
            - data-protection:/home/app/.aspnet/DataProtection-Keys
        networks:
            - body4uhub-network
        depends_on:
            data:
                condition: service_healthy
            message:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s
        deploy:
            resources:
                limits:
                    cpus: '1.0'
                    memory: 1G
                reservations:
                    cpus: '0.25'
                    memory: 256M
            
    content:
        container_name: content
        image: dkisov/body4u-hub-content-service
        build:
            context: ./
            dockerfile: ./Body4uHUB.Content.Api/Dockerfile
        ports:
            - "5002:8080"
        env_file:
            - ./Body4uHUB.Content.Api/content.env
        restart: unless-stopped
        volumes:
            - data-protection:/home/app/.aspnet/DataProtection-Keys
        networks:
            - body4uhub-network
        depends_on:
            data:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s
        deploy:
            resources:
                limits:
                    cpus: '1.0'
                    memory: 1G
                reservations:
                    cpus: '0.25'
                    memory: 256M
            
    marketplace:
        container_name: marketplace
        image: dkisov/body4u-hub-marketplace-service
        build:
            context: ./
            dockerfile: ./Body4uHUB.Services.Api/Dockerfile
        ports:
            - "5003:8080"
        env_file:
            - ./Body4uHUB.Services.Api/services.env
        restart: unless-stopped
        volumes:
            - data-protection:/home/app/.aspnet/DataProtection-Keys
        networks:
            - body4uhub-network
        depends_on:
            data:
                condition: service_healthy
            message:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s
        deploy:
            resources:
                limits:
                    cpus: '1.0'
                    memory: 1G
                reservations:
                    cpus: '0.25'
                    memory: 256M
            
networks:
    body4uhub-network:
    
volumes:
    sqldata:
    data-protection:
    rabbitmq-lib: